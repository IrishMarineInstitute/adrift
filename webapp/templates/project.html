<!DOCTYPE html>
<html>
<head>
<title>projection</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
<link rel="stylesheet" href="/static/css/leaflet.css" />
<script src="/static/js/leaflet.js"></script>
<script src="/static/js/jquery.min.js"></script>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
<script src="/static/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="/static/css/leaflet.timedimension.control.min.css" />
<script type="text/javascript" src="/static/js/leaflet.timedimension.min.js"></script>
<script type="text/javascript" src="/static/js/iso8601.js"></script>
<script type="text/javascript" src="/static/js/iso8601.min.js"></script>
<script type="text/javascript" src="/static/js/heatmap.min.js"></script>
<script type="text/javascript" src="/static/js/leaflet-heatmap.js"></script>
<link rel="stylesheet" href="/static/css/Leaflet.Coordinates-0.1.5.css" />
<script type="text/javascript" src="/static/js/Leaflet.Coordinates-0.1.5.min.js"></script>
<script src="times.json"></script>
<style>
#map { height: 600px; width: 800px;}
</style>
<script>
// Attibution: SODA API requests based on this example: https://github.com/chriswhong/soda-leaflet

L.TimeDimension.Layer.SODAHeatMap = L.TimeDimension.Layer.extend({
    _cachedData: {},

    initialize: function(options) {
        options = options || {};
        options.heatmapOptions = options.heatmapOptions || {};
        var heatmapCfg = {
            radius: 5,
            maxOpacity: .8,
            scaleRadius: false,
            useLocalExtrema: false,
            latField: 'lat',
            lngField: 'lng',
            valueField: 'count'
        };
        heatmapCfg = $.extend({}, heatmapCfg, options.heatmapOptions );
        var layer = new HeatmapOverlay(heatmapCfg);
        L.TimeDimension.Layer.prototype.initialize.call(this, layer, options);
        this._currentLoadedTime = 0;
        this._currentTimeData = {
            max: this.options.heatmapMax || 10,
            data: []
        };
    },

    onAdd: function(map) {
        L.TimeDimension.Layer.prototype.onAdd.call(this, map);
        map.addLayer(this._baseLayer);
        if (this._timeDimension) {
            this._getDataForTime(this._timeDimension.getCurrentTime());
        }
    },

    _onNewTimeLoading: function(ev) {
        this._getDataForTime(ev.time);
        return;
    },

    isReady: function(time) {
        return (this._currentLoadedTime == time);
    },

    _update: function() {
        this._baseLayer.setData(this._currentTimeData);
        var date = new Date(this._currentLoadedTime);
        $("#utctime").text(date.toISOString());
        $("#localtime").text(date.toString());
        var bounds = map.getBounds();
        bounds.extend(L.latLngBounds(this._currentTimeData.data));
        map.fitBounds(bounds);
        return true;
    },

    _getDataForTime: function(time) {
        var url = "point_"+new Date(time).toISOString().substring(0,19)+"Z.json";
        if(this._cachedData[url]){
            this._assignDataForTime(time,this._cachedData[url]);
        }else{
          $.getJSON(url, (function(data) {
            delete this._currentTimeData.data;
            var locations = [];
            for (var i = 0; i < data.length; i++) {
                 locations.push({
                        lat: data[i][0],
                        lng: data[i][1],
                        count: 1
                    });
            }
            this._cachedData[url] = locations;
            this._assignDataForTime(time,locations);
          }).bind(this));
        }
    },
    _assignDataForTime: function(time,locations){
        this._currentTimeData.data = locations;
        this._currentLoadedTime = time;
        if (this._timeDimension && time == this._timeDimension.getCurrentTime() && !this._timeDimension.isLoading()) {
            this._update();
        }
        this.fire('timeload', {
            time: time
        });
     }
  

});

L.timeDimension.layer.sodaHeatMap = function(options) {
    return new L.TimeDimension.Layer.SODAHeatMap(options);
};

</script>
<script>
var map = undefined;

$(document).ready(function(){
  $.ajax({url: "times.json"}).done(function(data){
     var times = [];
     var date = new Date();
     for(var i=0;i<data.length;i++){
       date.setISO8601(data[i]);
       times.push(date.getTime()); 
     }
     create_map(times);
  });
  $.ajax({url: "context.json"}).done(function(data){
    var keys = Object.keys(data);
    for(var i=0;i<keys.length;i++){
      var key = keys[i];
      $("#ctx_"+key).text(data[key]);
    }
  });
   
});
</script>
</head>
<body>
<div class="container">
<h1><a href="/">ADRIFT</a></h1>
<p class="lead">Welcome to the <a href="http://www.marine.ie/">Marine Institute</a> application for Advanced Data Representation Indicating Flow Trajectory (ADRIFT)</p> 
<h3 id="ctx_project_name"></h3>
<div class="row">
</div>
<div class="row">
  <div id="map" class="map col-md-9"></div>
  <div class='col-md-3'>
   <h3>Project Details</h3>
   <div class='table-responsive'>
    <table class="table">
      <tr><th class="text-right">Created</th><td id="ctx_created_time"></td></tr>
      <tr><th class="text-right">Start</th><td id="ctx_start_time"></td></tr>
      <tr><th class="text-right">End</th><td id="ctx_end_time"></td></tr>
      <tr><th class="text-right">Location</th><td>{{latitude}}, {{longitude}}</td></tr>
      <tr><th class="text-right">Radius</th><td id="ctx_radius"></td></tr>
      <tr><th class="text-right">Particles</th><td id="ctx_number_of_particles"></td></tr>
      <tr><th class="text-right">Model</th><td id="ctx_model"></td></tr>
    </table>
   </div>
   <h3>Current Display</h3>
   <div class='table-responsive'>
    <table class="table">
      <tr><th class="text-right">UTC Time</th><td id="utctime"></td></tr>
      <tr><th class="text-right">Local Time</th><td id="localtime"></td></tr>
    </table>
   </div>
   <h3>Downloads</h3>
   <div class='table-responsive'>
    <table id="downloads" class="table">
     <tr><td><a href="output.nc">Generated NetCDF File</td></tr>
    </table>
   </div>
  </div>
</div>
<script>
var create_map = function(times){
    map = L.map('map', {
    zoom: 13,
    fullscreenControl: true,
    timeDimensionControl: true,
    timeDimensionControlOptions: {
        position: 'bottomleft',
        autoPlay: false,
        timeSlider: true,
        loopButton: true,
        speedSlider: false,
        playerOptions: {
            transitionTime: 500,
            loop: false,
            buffer: 1
        }
    },
    timeDimension: true,
    timeDimensionOptions: {
       times: times,
       currentTime: times[0]
    },
    center: [{{latitude}}, {{longitude}}]
});
var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);
L.control.coordinates({
    position: "bottomright",
    decimals: 3,
    labelTemplateLat: "Latitude: {y}",
    labelTemplateLng: "Longitude: {x}",
    useDMS: false,
    enableUserInput: false
}).addTo(map);
L.timeDimension.layer.sodaHeatMap().addTo(map);
}

</script>
</div>
</body>
</html>
~

