<!DOCTYPE html>
<html>
<title>Project Status...</title>
<head>
<meta charset="utf-8">
<link rel="icon" href="/static/img/favicon.ico">
<link rel="stylesheet" href="/static/css/leaflet.css" />
<link rel="stylesheet" href="/static/css/bootstrap-slider.min.css" />
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/moment.min.js"></script>
<script src="/static/js/iso8601.js"></script>
<script src="/static/js/bootstrap-slider.min.js"></script>
<script src="/static/js/leaflet.js"></script>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="/static/css/Leaflet.Coordinates-0.1.5.css" />
<script type="text/javascript" src="/static/js/Leaflet.Coordinates-0.1.5.min.js"></script>
<style>
#map { height: 400px; width: 600px;}
.slider-selection {
	background: #BABABA;
}
</style>
<script>
var min_date = new Date().setISO8601("{{date_min}}");
var max_date = new Date().setISO8601("{{date_max}}");
var date_range_millis = max_date.getTime() - min_date.getTime();
var marker = undefined;
var update_marker_location = function(){
    var newLatLng = new L.LatLng(parseFloat($("#latitude").val()),parseFloat($("#longitude").val()));
    marker.setLatLng(newLatLng); 
}

var create_map = function(){
    map = L.map('map', {
    zoom: 12,
    fullscreenControl: true,
    center: [{{latitude}}, {{longitude}}]
    });
    var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);
  L.control.coordinates({
      position: "bottomright",
      decimals: 3,
      labelTemplateLat: "Latitude: {y}",
      labelTemplateLng: "Longitude: {x}",
      useDMS: false,
      enableUserInput: false
  }).addTo(map);
  marker = L.marker([{{latitude}}, {{longitude}}],{draggable: true}).addTo(map);
  marker.on('drag',function(e){
      $("#latitude").val(e.latlng.lat);
      $("#longitude").val(e.latlng.lng);
   });
  $("#latitude").change(update_marker_location);
  $("#longitude").change(update_marker_location);
};

var format_date = function(d){
   return d.toISOString().substring(0,19)+"Z";
}

$(document).ready(function(){
   $("#radius").slider({
	formatter: function(value) {
          $("#radius_label").text(value);
        }
     });
   $("#timeslider").slider({
	formatter: function(value) {
            if(!(value instanceof Array)){
              return "";
            }
            var t1 = Math.round(((value[0]/10000)*date_range_millis+min_date.getTime())/(1000*60*5))*1000*60*5;
            var t2 = Math.round(((value[1]/10000)*date_range_millis+min_date.getTime())/(1000*60*5))*1000*60*5;

            var s1 = new Date(t1).toISOString().substring(0,19)+"Z";
            var s2 = new Date(t2).toISOString().substring(0,19)+"Z";

            $("#start_time_label").text(s1);
            $("#start_time").val(s1);
            $("#end_time_label").text(s2);
            $("#end_time").val(s2);
	    return s1+" for "+moment.duration(t2-t1).humanize();
	}
    });
   create_map();
   $("#project_name").focus();
});
</script>
</head>
<body>
<div class="container">
<h1><a href="/">ADRIFT</a></h1>
<p class="lead"><a href="http://www.marine.ie/">Marine Institute</a> assisted discovery/recovery of interesting floating things.</p>
<div class="row">
<div class="col-md-12">
<form method="post" action="/api/model/{{model}}/projection">
  <h4>Enter New Project Start Location <small>or drag marker</small></h4>
  <div class="row">
   <div class="col-md-4">
     <div class="form-group">
       <label class="control-label">Latitude</label>
       <input required type="number" min="{{latitude_min}}" max="{{latitude_max}}" step="any" id="latitude" name="latitude" class="form-control" value="{{latitude}}" >
     </div>
     <div class="form-group">
       <label class="control-label">Longitude</label>
       <input required type="number" min="{{longitude_min}}" max="{{longitude_max}}" step="any" id="longitude" name="longitude" class="form-control" value="{{longitude}}" >
     </div>
     <div>
       <label class="control-label">UTC Time</label>
       <input id="timeslider" type="text" class="span2" value="" data-slider-tooltip="hide" data-slider-min="0" data-slider-max="10000" data-slider-step="1" data-slider-value="[3000,7000]"/>
     </div>
     <div class="form-group">
       <label class="control-label">Start: <span id="start_time_label"></span></label>
       <input type="hidden" id="start_time" name="start_time" value="{{date_min}}">
       <label class="control-label">End: <span id="end_time_label"></span></label>
       <input type="hidden" id="end_time" name="end_time" value="{{date_max}}">
     </div>
     <div class="form-group">
       <label class="control-label">Radius <span id="radius_label"></span> metres </label>
       <input id="radius" name="radius" data-slider-id='radius' data-slider-tooltip="hide" type="text" data-slider-min="5" data-slider-max="1000" data-slider-step="5" data-slider-value="250"/>
     </div>
     <div class="form-group">
      <button type="submit" class="btn btn-default">Submit</button>
      <a href="/" class="btn btn-default">Cancel</a>
     </div>
   </div>
   <div class="col-md-8">
     <div id="map"></div>
   </div>
  </div>
</form>
</div>
</div>
</div>
</body>
</html>
